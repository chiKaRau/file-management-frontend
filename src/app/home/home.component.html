<div class="home-page" (contextmenu)="onEmptyAreaRightClick($event)">
  <!-- home.component.html -->
  <!-- Top Toolbar -->
  <div class="home-toolbar">
    <button class="browse-icon" *ngIf="!dataSource.readOnly" (click)="openDirectory()">
      <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
        <path d="M10 4l2 2h8c1.1 0 2 .9 2 2v1H2V6c0-1.1.9-2 2-2h6zM2 9h20v9c0 1.1-.9 2-2 2H4
                   c-1.1 0-2-.9-2-2V9z" />
      </svg>
    </button>
    <app-explorer-toolbar [currentPath]="selectedDirectory" [canGoBack]="navigationService.canGoBack()"
      [canGoForward]="navigationService.canGoForward()" (back)="onBack()" (forward)="onForward()"
      [isPreloadComplete]="isPreloadComplete" (refresh)="onRefresh()" (searchQuery)="applySearch($event)"
      (pathChanged)="navigateByPath($event)" (toggleZipSidebarEvent)="toggleZipSidebar()"
      (updateAllModels)="updateAllModels()" (manualUpdateLocalPath)="updateLocalPath()"
      (subdirSelect)="openSubDirectoryWithoutHistory($event)">
      >
    </app-explorer-toolbar>
  </div>

  <!-- Main Content Area -->
  <div class="actual-content">
    <!-- Flex container for sidebar + file list -->
    <div class="main-container" [ngClass]="{'with-sidebar': selectedFile}">
      <!-- Permanent left dock (fixed width, no layout shift) -->
      <div class="left-dock">
        <ng-container *ngIf="selectedFile && !selectedFile.isDirectory; else dockEmpty">
          <app-file-info-sidebar [item]="selectedFile" (openModalEvent)="openModalFromSidebar($event)"
            (closed)="selectedFile = null">
          </app-file-info-sidebar>
        </ng-container>

        <ng-template #dockEmpty>
          <div class="dock-placeholder">
            <div class="placeholder-inner">
              <div class="placeholder-icon" aria-hidden="true">🛈</div>
              <div>Select a file to see details</div>
            </div>
          </div>
        </ng-template>
      </div>

      <!-- File list panel -->
      <!-- Note: Added (contextmenu)="onEmptyAreaRightClick($event)" here -->
      <div class="file-list-container">
        <div *ngIf="isLoading" class="loading">
          Loading files...
        </div>

        <div *ngIf="infoMessage" class="info">
          {{ infoMessage }}
        </div>

        <div *ngIf="isPreloadComplete" class="update-overlay">
          <div class="update-message">
            Preloading, please wait...
          </div>
        </div>

        <div *ngIf="!isLoading && selectedDirectory">
          <div *ngIf="errorMessage" class="error">{{ errorMessage }}</div>
          <app-file-list #fileList [items]="filteredDirectoryContents" [viewMode]="explorerState.viewMode"
            (openFolder)="openSubDirectory($event)" (fileRightClick)="onFileRightClick($event.file, $event.event)"
            (selectionChanged)="onSelectionChanged($event)">
          </app-file-list>
        </div>

        <div *ngIf="!selectedDirectory && !errorMessage && !isLoading">
          <p>No directory selected.</p>
        </div>
      </div>

      <!-- Permanent right dock (no layout shift) -->
      <!-- Permanent right dock (no layout shift) -->
      <div class="right-dock">
        <!-- Show Update if open, otherwise Zip, otherwise placeholder -->
        <ng-container *ngIf="showUpdateSidebar; else checkZip">
          <app-update-sidebar [item]="updateFile" (closed)="closeUpdateSidebar()">
          </app-update-sidebar>
        </ng-container>

        <ng-template #checkZip>
          <ng-container *ngIf="showZipSidebar; else rightDockEmpty">
            <app-zip-sidebar [directoryContents]="directoryContents" (closed)="closeZipSidebar()"
              (selectSetsEvent)="handleSelectUnzippedSets($event)">
            </app-zip-sidebar>
          </ng-container>
        </ng-template>

        <ng-template #rightDockEmpty>
          <div class="right-dock-placeholder">
            <div class="placeholder-inner">
              <div class="placeholder-icon" aria-hidden="true">🛠️</div>
              <div>Open “Update” or “Zip” to manage sets</div>
            </div>
          </div>
        </ng-template>
      </div>

    </div>
  </div>

  <!-- Empty-Area Context Menu -->
  <div class="context-menu" *ngIf="showEmptyAreaContextMenu" [style.left.px]="menuX" [style.top.px]="menuY"
    (click)="onMenuClick($event)" (contextmenu)="$event.preventDefault()">
    <div class="menu-item" (mouseenter)="onMouseEnterViewSubmenu($event)"
      (mouseleave)="viewSubmenuOpen = false; viewSubmenuShouldFlip = false;">
      View >
      <div class="submenu" #viewSubmenu id="view-submenu" *ngIf="viewSubmenuOpen"
        [ngClass]="{ 'flip-submenu': viewSubmenuShouldFlip }">
        <div class="submenu-item" (click)="switchView('extraLarge')">Extra large icons</div>
        <div class="submenu-item" (click)="switchView('large')">Large icons</div>
        <div class="submenu-item" (click)="switchView('medium')">Medium icons</div>
        <div class="submenu-item" (click)="switchView('small')">Small icons</div>
        <div class="submenu-item" (click)="switchView('list')">List</div>
        <div class="submenu-item" (click)="switchView('details')">Details</div>
      </div>
    </div>
    <div class="menu-item" (mouseenter)="onMouseEnterSortSubmenu($event)"
      (mouseleave)="sortSubmenuOpen = false; sortSubmenuShouldFlip = false;">
      Sort by >
      <div class="submenu" #sortSubmenu *ngIf="sortSubmenuOpen" [ngClass]="{ 'flip-submenu': sortSubmenuShouldFlip }">
        <div class="submenu-item" (click)="setSort('name')">
          <span *ngIf="sortKey==='name'">✓</span> Name
          <span *ngIf="sortKey==='name'">{{ sortDir==='asc' ? '↑' : '↓' }}</span>
        </div>
        <div class="submenu-item" (click)="setSort('size')">
          <span *ngIf="sortKey==='size'">✓</span> File size
          <span *ngIf="sortKey==='size'">{{ sortDir==='asc' ? '↑' : '↓' }}</span>
        </div>
        <div class="submenu-item" (click)="setSort('modified')">
          <span *ngIf="sortKey==='modified'">✓</span> Date modified
          <span *ngIf="sortKey==='modified'">{{ sortDir==='asc' ? '↑' : '↓' }}</span>
        </div>
        <div class="submenu-item" (click)="setSort('created')">
          <span *ngIf="sortKey==='created'">✓</span> Date created
          <span *ngIf="sortKey==='created'">{{ sortDir==='asc' ? '↑' : '↓' }}</span>
        </div>

        <div class="submenu-item" style="border-top:1px solid rgba(255,255,255,.15); margin-top:4px; padding-top:4px"
          (click)="toggleSortDirection()">
          Reverse order
        </div>
      </div>
    </div>
    <div class="menu-item" *ngIf="!dataSource.readOnly && clipboard" (click)="pasteFiles()">Paste</div>
    <div class="menu-item" *ngIf="!dataSource.readOnly" (click)="openNativeFileExplorer()">Open in File Explorer</div>
    <div class="menu-item" (click)="refresh()">Refresh</div>

  </div>

  <!-- File-Based Context Menu -->
  <div class="context-menu" *ngIf="showFileContextMenu" [style.left.px]="menuX" [style.top.px]="menuY"
    (click)="onMenuClick($event)" (contextmenu)="$event.preventDefault()">
    <div class="menu-item" *ngIf="!dataSource.readOnly && !hasDeletedFiles()" (click)="cutFile()">Cut</div>
    <div class="menu-item" *ngIf="!dataSource.readOnly && !hasDeletedFiles()" (click)="copyFile()">Copy</div>
    <div class="menu-item" *ngIf="!dataSource.readOnly && recycleService.arePathsSet" (click)="deleteFiles()">
      Delete
    </div>
    <div class="menu-item" *ngIf="!dataSource.readOnly && recycleService.arePathsSet && contextFile?.isDeleted"
      (click)="restoreFiles()">
      Restore
    </div>
    <div class="menu-item"
      *ngIf="!dataSource.readOnly && preferencesService.scanVerified && recycleService.arePathsSet && ((selectedFiles.length === 1 && selectedFiles[0].isFile) || (!selectedFiles.length && contextFile?.isFile))"
      (click)="openUpdateSidebar()">Update</div>
    <div class="menu-item" *ngIf="!dataSource.readOnly" (click)="renameFile()">Rename</div>
    <div class="menu-item" *ngIf="!dataSource.readOnly" (click)="showProperties()">Properties</div>
  </div>

  <!-- Full-screen modal overlay rendered at the root level -->
  <app-model-modal *ngIf="selectedModelVersion" [modelVersion]="selectedModelVersion" (close)="closeModal()">
  </app-model-modal>

  <!-- Full-screen update overlay -->
  <div *ngIf="isUpdatingAllModels" class="update-overlay-full">
    <div class="update-message-full">
      <h2>Updating models...</h2>
      <p>Currently updating: {{ currentUpdateModel }}</p>
    </div>
  </div>


</div>