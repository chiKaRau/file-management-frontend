<div class="home-page" (contextmenu)="onEmptyAreaRightClick($event)">
  <!-- home.component.html -->
  <!-- Top Toolbar -->
  <div class="home-toolbar">
    <button class="browse-icon" *ngIf="!dataSource.readOnly" (click)="openDirectory()">
      <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
        <path d="M10 4l2 2h8c1.1 0 2 .9 2 2v1H2V6c0-1.1.9-2 2-2h6zM2 9h20v9c0 1.1-.9 2-2 2H4
                   c-1.1 0-2-.9-2-2V9z" />
      </svg>
    </button>
    <app-explorer-toolbar *ngIf="!isReadOnly" [currentPath]="selectedDirectory"
      [canGoBack]="navigationService.canGoBack()" [canGoForward]="navigationService.canGoForward()"
      [isReadOnly]="isReadOnly" (back)="onBack()" (forward)="onForward()" [isPreloadComplete]="isPreloadComplete"
      (refresh)="onRefresh()" (searchQuery)="applySearch($event)" (pathChanged)="navigateByPath($event)"
      (toggleZipSidebarEvent)="toggleZipSidebar()" (updateAllModels)="updateAllModels()"
      (lockContextChange)="onLockContextChange($event)" [visitedSubDirectories]="visitedSubdirs"
      (manualUpdateLocalPath)="updateLocalPath()" (subdirSelect)="openSubDirectoryWithoutHistory($event)">
    </app-explorer-toolbar>

    <app-virtual-explorer-toolbar *ngIf="isReadOnly" [currentPath]="selectedDirectory"
      [canGoBack]="navigationService.canGoBack()" [canGoForward]="navigationService.canGoForward()"
      [isPreloadComplete]="isPreloadComplete" [availableDrives]="availableDrives" [groupingMode]="groupingMode"
      [selectedDrive]="selectedDrive" (back)="onBack()" (forward)="onForward()" (refresh)="onRefresh()"
      (searchQuery)="applySearch($event)" (pathChanged)="onVirtualPathChange($event)"
      (driveChanged)="onVirtualDriveChange($event)" (updateStats)="updateAllModels()"
      (deepSearch)="onDeepSearch($event)" (deepClear)="clearDeepSearch()">
    </app-virtual-explorer-toolbar>
  </div>

  <!-- Main Content Area -->
  <div class="actual-content">
    <!-- Flex container for sidebar + file list -->
    <div class="main-container" [ngClass]="{'with-sidebar': selectedFile}">
      <!-- Permanent left dock (fixed width, no layout shift) -->
      <div class="left-dock">
        <ng-container *ngIf="selectedFile && !selectedFile.isDirectory; else dockEmpty">
          <app-file-info-sidebar [item]="selectedFile" (myRatingChanged)="onMyRatingChanged()"
            (openModalEvent)="openModalFromSidebar($event)" (closed)="selectedFile = null">
          </app-file-info-sidebar>
        </ng-container>

        <ng-template #dockEmpty>
          <div class="dock-placeholder">
            <div class="placeholder-inner">
              <div class="placeholder-icon" aria-hidden="true">ğŸ›ˆ</div>
              <div>Select a file to see details</div>
            </div>
          </div>
        </ng-template>
      </div>

      <!-- File list panel -->
      <!-- Note: Added (contextmenu)="onEmptyAreaRightClick($event)" here -->
      <div class="file-list-container" #scrollRoot>
        <div *ngIf="isLoading" class="loading">
          Loading files...
        </div>

        <div *ngIf="infoMessage" class="info">
          {{ infoMessage }}
        </div>

        <div *ngIf="isPreloadComplete" class="update-overlay">
          <div class="update-message">
            Preloading, please wait...
          </div>
        </div>

        <div *ngIf="!isLoading && selectedDirectory">
          <div *ngIf="errorMessage" class="error">{{ errorMessage }}</div>

          <!-- Banner for deep-search results -->
          <div *ngIf="deepSearchActive" class="info" style="display:flex;align-items:center;gap:.5rem;">
            <span class="deep-search-banner__label">Deep search:</span>
            <span class="deep-search-banner__count">
              {{ deepSearchItems.length | number }} result{{ deepSearchItems.length === 1 ? '' : 's' }}
            </span>


            <button class="btn" (click)="clearDeepSearch()" aria-label="Clear deep search">
              <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
                <path
                  d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" />
              </svg>
              <span>Clear</span>
            </button>
          </div>


          <app-file-list #fileList [items]="visibleItems" [filesViewMode]="filesViewMode"
            [foldersViewMode]="foldersViewMode" [isReadOnly]="isReadOnly" [combined]="true"
            (openFolder)="openSubDirectory($event)" (fileRightClick)="onFileRightClick($event.file, $event.event)"
            (selectionChanged)="onSelectionChanged($event)">
          </app-file-list>


        </div>

        <div *ngIf="!selectedDirectory && !errorMessage && !isLoading">
          <p>No directory selected.</p>
        </div>

        <!-- Sentinel to trigger loading more -->
        <div #infiniteSentinel class="infinite-sentinel" aria-hidden="true"></div>
      </div>

      <!-- Permanent right dock (no layout shift) -->
      <!-- Permanent right dock (no layout shift) -->
      <div class="right-dock">
        <!-- Show Update if open, otherwise Zip, otherwise placeholder -->
        <ng-container *ngIf="showUpdateSidebar; else checkZip">
          <app-update-sidebar [item]="updateFile" (closed)="closeUpdateSidebar()">
          </app-update-sidebar>
        </ng-container>

        <ng-template #checkZip>
          <ng-container *ngIf="showZipSidebar; else rightDockEmpty">
            <app-zip-sidebar [directoryContents]="directoryContents" (closed)="closeZipSidebar()"
              (selectSetsEvent)="handleSelectUnzippedSets($event)">
            </app-zip-sidebar>
          </ng-container>
        </ng-template>

        <ng-template #rightDockEmpty>
          <div class="right-dock-placeholder">
            <div class="placeholder-inner">
              <div class="placeholder-icon" aria-hidden="true">ğŸ› ï¸</div>
              <div>Open â€œUpdateâ€ or â€œZipâ€ to manage sets</div>
            </div>
          </div>
        </ng-template>
      </div>

    </div>
  </div>

  <!-- Fixed status bar sized to the middle column -->
  <!-- Fixed status bar sized to the middle column -->
  <div class="list-status-bar fixed" #statusBar [class.stacked]="isReadOnly || searchTerm">
    <div class="left">
      {{ totalFilesCount | number }} file{{ totalFilesCount === 1 ? '' : 's' }}
      <span *ngIf="totalDirsCount">
        Â· {{ totalDirsCount | number }} folder{{ totalDirsCount === 1 ? '' : 's' }}
      </span>
    </div>

    <div class="right" *ngIf="isReadOnly || searchTerm">
      <ng-container *ngIf="isReadOnly; else searchOnly">
        showing {{ visibleFilesCount | number }} of {{ totalFilesCount | number }}
      </ng-container>
      <ng-template #searchOnly>
        showing {{ visibleFilesCount | number }}
      </ng-template>
    </div>
  </div>


  <!-- Empty-Area Context Menu -->
  <div class="context-menu" *ngIf="showEmptyAreaContextMenu" [style.left.px]="menuX" [style.top.px]="menuY"
    (click)="onMenuClick($event)" (contextmenu)="$event.preventDefault()">
    <!-- View files as > -->
    <div class="menu-item" (mouseenter)="onMouseEnterFileViewSubmenu($event)"
      (mouseleave)="fileViewSubmenuOpen = false; fileViewSubmenuShouldFlip = false;">
      View files as >
      <div class="submenu" #fileViewSubmenu *ngIf="fileViewSubmenuOpen"
        [ngClass]="{ 'flip-submenu': fileViewSubmenuShouldFlip }">
        <div class="submenu-item" (click)="switchFilesView('extraLarge')">
          <span *ngIf="filesViewMode==='extraLarge'">âœ“</span> Extra large icons
        </div>
        <div class="submenu-item" (click)="switchFilesView('large')">
          <span *ngIf="filesViewMode==='large'">âœ“</span> Large icons
        </div>
        <div class="submenu-item" (click)="switchFilesView('medium')">
          <span *ngIf="filesViewMode==='medium'">âœ“</span> Medium icons
        </div>
        <div class="submenu-item" (click)="switchFilesView('small')">
          <span *ngIf="filesViewMode==='small'">âœ“</span> Small icons
        </div>
        <div class="submenu-item" (click)="switchFilesView('list')">
          <span *ngIf="filesViewMode==='list'">âœ“</span> List
        </div>
        <div class="submenu-item" (click)="switchFilesView('details')">
          <span *ngIf="filesViewMode==='details'">âœ“</span> Details
        </div>
      </div>
    </div>

    <!-- View folders as > -->
    <div class="menu-item" (mouseenter)="onMouseEnterDirViewSubmenu($event)"
      (mouseleave)="dirViewSubmenuOpen = false; dirViewSubmenuShouldFlip = false;">
      View folders as >
      <div class="submenu" #dirViewSubmenu *ngIf="dirViewSubmenuOpen"
        [ngClass]="{ 'flip-submenu': dirViewSubmenuShouldFlip }">
        <div class="submenu-item" (click)="switchFoldersView('extraLarge')">
          <span *ngIf="foldersViewMode==='extraLarge'">âœ“</span> Extra large icons
        </div>
        <div class="submenu-item" (click)="switchFoldersView('large')">
          <span *ngIf="foldersViewMode==='large'">âœ“</span> Large icons
        </div>
        <div class="submenu-item" (click)="switchFoldersView('medium')">
          <span *ngIf="foldersViewMode==='medium'">âœ“</span> Medium icons
        </div>
        <div class="submenu-item" (click)="switchFoldersView('small')">
          <span *ngIf="foldersViewMode==='small'">âœ“</span> Small icons
        </div>
        <div class="submenu-item" (click)="switchFoldersView('list')">
          <span *ngIf="foldersViewMode==='list'">âœ“</span> List
        </div>
        <div class="submenu-item" (click)="switchFoldersView('details')">
          <span *ngIf="foldersViewMode==='details'">âœ“</span> Details
        </div>
      </div>
    </div>

    <div class="menu-item" (mouseenter)="onMouseEnterSortSubmenu($event)"
      (mouseleave)="sortSubmenuOpen = false; sortSubmenuShouldFlip = false;">
      Sort by >
      <div class="submenu" #sortSubmenu *ngIf="sortSubmenuOpen" [ngClass]="{ 'flip-submenu': sortSubmenuShouldFlip }">
        <div class="submenu-item" (click)="setSort('name')">
          <span *ngIf="sortKey==='name'">âœ“</span> Name
          <span *ngIf="sortKey==='name'">{{ sortDir==='asc' ? 'â†‘' : 'â†“' }}</span>
        </div>
        <div class="submenu-item" (click)="setSort('modelNumber')">
          <span *ngIf="sortKey==='modelNumber'">âœ“</span> Model #
          <span *ngIf="sortKey==='modelNumber'">{{ sortDir==='asc' ? 'â†‘' : 'â†“' }}</span>
        </div>
        <div class="submenu-item" (click)="setSort('versionNumber')">
          <span *ngIf="sortKey==='versionNumber'">âœ“</span> Version #
          <span *ngIf="sortKey==='versionNumber'">{{ sortDir==='asc' ? 'â†‘' : 'â†“' }}</span>
        </div>

        <div class="submenu-item" (click)="setSort('size')">
          <span *ngIf="sortKey==='size'">âœ“</span> File size
          <span *ngIf="sortKey==='size'">{{ sortDir==='asc' ? 'â†‘' : 'â†“' }}</span>
        </div>
        <div class="submenu-item" (click)="setSort('myRating')">
          <span *ngIf="sortKey==='myRating'">âœ“</span> My rating
          <span *ngIf="sortKey==='myRating'">{{ sortDir==='asc' ? 'â†‘' : 'â†“' }}</span>
        </div>

        <div class="submenu-item" (click)="setSort('modified')">
          <span *ngIf="sortKey==='modified'">âœ“</span> Date modified
          <span *ngIf="sortKey==='modified'">{{ sortDir==='asc' ? 'â†‘' : 'â†“' }}</span>
        </div>
        <div class="submenu-item" (click)="setSort('created')">
          <span *ngIf="sortKey==='created'">âœ“</span> Date created
          <span *ngIf="sortKey==='created'">{{ sortDir==='asc' ? 'â†‘' : 'â†“' }}</span>
        </div>

      </div>
    </div>
    <div class="menu-item" *ngIf="!dataSource.readOnly && clipboard" (click)="pasteFiles()">Paste</div>
    <div class="menu-item" *ngIf="!dataSource.readOnly" (click)="openNativeFileExplorer()">Open in File Explorer</div>
    <div class="menu-item" (click)="refresh()">Refresh</div>

  </div>

  <!-- File-Based Context Menu -->
  <div class="context-menu" *ngIf="showFileContextMenu" [style.left.px]="menuX" [style.top.px]="menuY"
    (click)="onMenuClick($event)" (contextmenu)="$event.preventDefault()">
    <div class="menu-item" *ngIf="!dataSource.readOnly && !hasDeletedFiles()" (click)="cutFile()">Cut</div>
    <div class="menu-item" *ngIf="!dataSource.readOnly && !hasDeletedFiles()" (click)="copyFile()">Copy</div>
    <div class="menu-item" *ngIf="!dataSource.readOnly && recycleService.arePathsSet" (click)="deleteFiles()">
      Delete
    </div>
    <div class="menu-item" *ngIf="!dataSource.readOnly && recycleService.arePathsSet && contextFile?.isDeleted"
      (click)="restoreFiles()">
      Restore
    </div>
    <div class="menu-item"
      *ngIf="!dataSource.readOnly && preferencesService.scanVerified && recycleService.arePathsSet && ((selectedFiles.length === 1 && selectedFiles[0].isFile) || (!selectedFiles.length && contextFile?.isFile))"
      (click)="openUpdateSidebar()">Upgrade</div>
    <div class="menu-item" *ngIf="!dataSource.readOnly" (click)="renameFile()">Rename</div>
    <div class="menu-item" *ngIf="!dataSource.readOnly" (click)="showProperties()">Properties</div>
  </div>

  <!-- Full-screen modal overlay rendered at the root level -->
  <app-model-modal *ngIf="selectedModelVersion" [modelVersion]="selectedModelVersion" (close)="closeModal()">
  </app-model-modal>

  <!-- Full-screen update overlay -->
  <div *ngIf="isUpdatingAllModels" class="update-overlay-full">
    <div class="update-message-full">
      <h2>Updating models...</h2>
      <p>Currently updating: {{ currentUpdateModel }}</p>
    </div>
  </div>


</div>