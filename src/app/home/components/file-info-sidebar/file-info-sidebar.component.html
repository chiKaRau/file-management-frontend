<div class="sidebar">
    <div class="header">
        <h3>Details</h3>
        <button (click)="close()">X</button>
    </div>

    <div *ngIf="item" class="content">
        <!-- LIVE (Civitai) mini carousel -->
        <div class="carousel">
            <button class="carousel-btn" (click)="prevImage()">&#10094;</button>
            <!-- NOTE: keep openModal() in template; we'll repurpose it in TS to open full-screen overlay -->
            <img class="carousel-image" [src]="currentImageUrl" alt="Model Image" (click)="openModal()" />
            <button class="carousel-btn" (click)="nextImage()">&#10095;</button>
        </div>

        <p><strong>Name:</strong> {{ item.name }}</p>
        <p><strong>Path:</strong> {{ item.path }}</p>
        <p><strong>Type:</strong> {{ item.isDirectory ? 'Folder' : 'File' }}</p>

        <!-- Spinner when loading LIVE -->
        <div *ngIf="isLoading">
            <p>Loading model details...</p>
        </div>

        <!-- Error message if LIVE loading failed -->
        <div *ngIf="error" class="error">
            <p class="error">{{ error }}</p>
        </div>

        <!-- LIVE details -->
        <div *ngIf="!isLoading && !error && modelVersion">
            <p><strong>Base Model:</strong> {{ modelVersion.baseModel }}</p>
            <p><strong>Model Name:</strong> {{ modelVersion.model?.name }}</p>
            <p>
                <strong>Trained Words:</strong>
                <span *ngIf="modelVersion.trainedWords && modelVersion.trainedWords.length; else noTW">
                    {{ modelVersion.trainedWords.join(', ') }}
                </span>
                <ng-template #noTW>‚Äî</ng-template>
            </p>
            <p>
                <strong>Stats:</strong>
                Downloads: {{ modelVersion.stats?.downloadCount ?? '‚Äî' }},
                Thumbs Up: {{ modelVersion.stats?.thumbsUpCount ?? '‚Äî' }}
            </p>
        </div>

        <a [href]="'https://civitai.com/models/' + (modelVersion?.modelId) + '?modelVersionId=' + modelVersion?.id"
            target="_blank" rel="noopener noreferrer">
            Go to Model
        </a>

        <hr />

        <!-- Button to open the IN-SIDEBAR local overlay (unchanged) -->
        <div class="db-actions">
            <button class="db-button" (click)="openDbOverlay()">View Local Record</button>
        </div>
    </div>

    <!-- ===== IN-SIDEBAR bottom sheet overlay (unchanged) ===== -->
    <div class="db-panel-backdrop" *ngIf="dbOverlayOpen" (click)="closeDbOverlay()"></div>

    <div class="db-panel" *ngIf="dbOverlayOpen" (click)="$event.stopPropagation()">
        <div class="db-panel-header">
            <h3>Local Record</h3>
            <button class="db-close" (click)="closeDbOverlay()">‚úï</button>
        </div>

        <div class="db-panel-body">
            <div *ngIf="dbLoading" class="overlay-loading">Loading local record‚Ä¶</div>
            <div *ngIf="dbError" class="overlay-error">{{ dbError }}</div>

            <ng-container *ngIf="!dbLoading && !dbError && dbData">
                <!-- LOCAL carousel INSIDE sidebar overlay -->
                <div class="overlay-carousel" *ngIf="dbImages.length">
                    <button class="carousel-btn" (click)="prevDbImage()">&#10094;</button>
                    <!-- CLICK HERE opens the FULL-SCREEN overlay with LOCAL data -->
                    <img class="overlay-image" [src]="dbImages[dbImageIndex].url" alt="Local record image"
                        (click)="openFullOverlay('local', dbImageIndex)" />
                    <button class="carousel-btn" (click)="nextDbImage()">&#10095;</button>
                </div>

                <!-- Details grid -->
                <div class="overlay-grid">
                    <div class="row"><label>Category</label>
                        <div>{{ dbData?.model?.category }}</div>
                    </div>
                    <div class="row"><label>Type</label>
                        <div>{{ dbData?.details?.type }}</div>
                    </div>
                    <div class="row"><label>Version #</label>
                        <div>{{ dbData?.model?.versionNumber }}</div>
                    </div>
                    <div class="row"><label>Model #</label>
                        <div>{{ dbData?.model?.modelNumber }}</div>
                    </div>
                    <div class="row"><label>Local Path</label>
                        <div class="mono">{{ dbData?.model?.localPath }}</div>
                    </div>
                    <div class="row"><label>Name</label>
                        <div>{{ dbData?.model?.name }}</div>
                    </div>
                    <div class="row"><label>Main Model Name</label>
                        <div>{{ dbData?.model?.mainModelName }}</div>
                    </div>

                    <div class="row">
                        <label>Tags</label>
                        <div>
                            <ng-container *ngIf="dbTags?.length; else noTags">
                                <span class="chip" *ngFor="let t of dbTags">{{ t }}</span>
                            </ng-container>
                            <ng-template #noTags>‚Äî</ng-template>
                        </div>
                    </div>

                    <div class="row">
                        <label>Trigger Words</label>
                        <div>
                            <ng-container *ngIf="dbTriggerWords?.length; else noTrig">
                                <span class="chip" *ngFor="let w of dbTriggerWords">{{ w }}</span>
                            </ng-container>
                            <ng-template #noTrig>‚Äî</ng-template>
                        </div>
                    </div>

                    <div class="row">
                        <label>Stats</label>
                        <div class="mono">
                            <ng-container *ngIf="dbStats; else noStats">
                                Downloads: {{ dbStats.downloadCount ?? '‚Äî' }} |
                                Rating: {{ dbStats.rating ?? '‚Äî' }} ({{ dbStats.ratingCount ?? '‚Äî' }}) |
                                üëç {{ dbStats.thumbsUpCount ?? '‚Äî' }}
                            </ng-container>
                            <ng-template #noStats>‚Äî</ng-template>
                        </div>
                    </div>

                    <!-- creator / urlAccessible / created / updated -->
                    <div class="row"><label>Creator</label>
                        <div>{{ dbCreator || '‚Äî' }}</div>
                    </div>

                    <div class="row">
                        <label>URL Accessible</label>
                        <div>
                            <span class="bool-pill" [class.true]="dbUrlAccessible === true"
                                [class.false]="dbUrlAccessible === false">
                                {{ dbUrlAccessible === true ? 'Yes' : (dbUrlAccessible === false ? 'No' : '‚Äî') }}
                            </span>
                        </div>
                    </div>

                    <div class="row"><label>Created</label>
                        <div>{{ dbCreatedAt | date:'medium' }}</div>
                    </div>
                    <div class="row"><label>Updated</label>
                        <div>{{ dbUpdatedAt | date:'medium' }}</div>
                    </div>
                </div>
            </ng-container>
        </div>
    </div>
</div>

<!-- ===== FULL-SCREEN bottom-sheet overlay (new) ===== -->
<div class="full-overlay-backdrop" *ngIf="fullOverlayOpen" (click)="closeFullOverlay()"></div>

<div class="full-bottom-sheet" *ngIf="fullOverlayOpen" (click)="$event.stopPropagation()">
    <div class="sheet-header">
        <h3>{{ fullSource === 'local' ? 'Local Record' : 'Live Details' }}</h3>
        <button class="sheet-close" (click)="closeFullOverlay()">‚úï</button>
    </div>

    <div class="sheet-body">
        <div *ngIf="fullLoading" class="overlay-loading">Loading‚Ä¶</div>
        <div *ngIf="fullError" class="overlay-error">{{ fullError }}</div>

        <ng-container *ngIf="!fullLoading && !fullError">
            <!-- source-aware carousel -->
            <div class="overlay-carousel" *ngIf="fullImages.length">
                <button class="carousel-btn" (click)="prevFullImage()">&#10094;</button>
                <img *ngIf="fullImages && fullImages.length > fullImageIndex" class="overlay-image"
                    [src]="fullImages[fullImageIndex].url" alt="image" />
                <button class="carousel-btn" (click)="nextFullImage()">&#10095;</button>
            </div>

            <!-- LOCAL details in full-screen overlay -->
            <div class="overlay-grid" *ngIf="fullSource === 'local'">
                <div class="row"><label>Category</label>
                    <div>{{ dbData?.model?.category || '‚Äî' }}</div>
                </div>
                <div class="row"><label>Type</label>
                    <div>{{ dbData?.details?.type || '‚Äî' }}</div>
                </div>
                <div class="row"><label>Version #</label>
                    <div>{{ dbData?.model?.versionNumber || '‚Äî' }}</div>
                </div>
                <div class="row"><label>Model #</label>
                    <div>{{ dbData?.model?.modelNumber || '‚Äî' }}</div>
                </div>
                <div class="row"><label>Local Path</label>
                    <div class="mono">{{ dbData?.model?.localPath || '‚Äî' }}</div>
                </div>
                <div class="row"><label>Name</label>
                    <div>{{ dbData?.model?.name || '‚Äî' }}</div>
                </div>
                <div class="row"><label>Main Model Name</label>
                    <div>{{ dbData?.model?.mainModelName || '‚Äî' }}</div>
                </div>
                <div class="row"><label>Creator</label>
                    <div>{{ dbCreator || '‚Äî' }}</div>
                </div>
                <div class="row">
                    <label>URL</label>
                    <div>
                        <a *ngIf="dbData?.url?.url" [href]="dbData?.url?.url" target="_blank" rel="noopener noreferrer">
                            {{ dbData?.url?.url }}
                        </a>
                        <span *ngIf="!dbData?.url?.url">‚Äî</span>
                    </div>
                </div>
                <div class="row">
                    <label>URL Accessible</label>
                    <div>
                        <span class="bool-pill" [class.true]="dbUrlAccessible === true"
                            [class.false]="dbUrlAccessible === false">
                            {{ dbUrlAccessible === true ? 'Yes' : (dbUrlAccessible === false ? 'No' : '‚Äî') }}
                        </span>
                    </div>
                </div>
                <div class="row"><label>Created</label>
                    <div>{{ dbCreatedAt | date:'medium' }}</div>
                </div>
                <div class="row"><label>Updated</label>
                    <div>{{ dbUpdatedAt | date:'medium' }}</div>
                </div>

                <div class="row">
                    <label>Tags</label>
                    <div>
                        <ng-container *ngIf="dbTags?.length; else noTagsFS">
                            <span class="chip" *ngFor="let t of dbTags">{{ t }}</span>
                        </ng-container>
                        <ng-template #noTagsFS>‚Äî</ng-template>
                    </div>
                </div>

                <div class="row">
                    <label>Trigger Words</label>
                    <div>
                        <ng-container *ngIf="dbTriggerWords?.length; else noTrigFS">
                            <span class="chip" *ngFor="let w of dbTriggerWords">{{ w }}</span>
                        </ng-container>
                        <ng-template #noTrigFS>‚Äî</ng-template>
                    </div>
                </div>

                <div class="row">
                    <label>Stats</label>
                    <div class="mono">
                        <ng-container *ngIf="dbStats; else noStatsFS">
                            Downloads: {{ dbStats.downloadCount ?? '‚Äî' }} |
                            Rating: {{ dbStats.rating ?? '‚Äî' }} ({{ dbStats.ratingCount ?? '‚Äî' }}) |
                            üëç {{ dbStats.thumbsUpCount ?? '‚Äî' }}
                        </ng-container>
                        <ng-template #noStatsFS>‚Äî</ng-template>
                    </div>
                </div>
            </div>

            <!-- LIVE details in full-screen overlay -->
            <div class="overlay-grid" *ngIf="fullSource === 'live'">
                <div class="row"><label>Model</label>
                    <div>{{ modelVersion?.model?.name || '‚Äî' }}</div>
                </div>
                <div class="row"><label>Base Model</label>
                    <div>{{ modelVersion?.baseModel || '‚Äî' }}</div>
                </div>
                <div class="row">
                    <label>Trained Words</label>
                    <div>
                        <ng-container *ngIf="modelVersion?.trainedWords?.length; else noTWov">
                            <span class="chip" *ngFor="let w of modelVersion?.trainedWords">{{ w }}</span>
                        </ng-container>
                        <ng-template #noTWov>‚Äî</ng-template>
                    </div>
                </div>
                <div class="row">
                    <label>Stats</label>
                    <div class="mono">
                        Downloads: {{ modelVersion?.stats?.downloadCount ?? '‚Äî' }} |
                        üëç {{ modelVersion?.stats?.thumbsUpCount ?? '‚Äî' }}
                    </div>
                </div>
                <div class="row">
                    <label>Link</label>
                    <div>
                        <a *ngIf="modelVersion?.modelId"
                            [href]="'https://civitai.com/models/' + modelVersion.modelId + '?modelVersionId=' + modelVersion?.id"
                            target="_blank" rel="noopener noreferrer">Open on Civitai</a>
                        <span *ngIf="!modelVersion?.modelId">‚Äî</span>
                    </div>
                </div>
            </div>
        </ng-container>
    </div>
</div>