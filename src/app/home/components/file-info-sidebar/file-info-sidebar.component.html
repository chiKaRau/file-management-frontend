<div class="sidebar">
    <div class="header">
        <h3>Details</h3>
        <button (click)="close()">X</button>
    </div>

    <div *ngIf="item" class="content">
        <!-- LIVE (Civitai) mini carousel -->
        <div class="carousel">
            <button class="carousel-btn" (click)="prevImage()"
                [disabled]="!(modelVersion?.images?.length > 1)">&#10094;</button>
            <!-- NOTE: keep openModal() in template; we'll repurpose it in TS to open full-screen overlay -->
            <!-- Sidebar mini carousel -->
            <img class="carousel-image" [src]="currentImageUrl" alt="Model Image" loading="lazy" decoding="async"
                fetchpriority="low" (click)="openModal()" />

            <button class="carousel-btn" (click)="nextImage()"
                [disabled]="!(modelVersion?.images?.length > 1)">&#10095;</button>
        </div>

        <p><strong>Name:</strong> {{ item.name }}</p>
        <p><strong>Path:</strong> {{ item.path }}</p>
        <p><strong>Type:</strong> {{ item.isDirectory ? 'Folder' : 'File' }}</p>

        <!-- Spinner when loading LIVE -->
        <div *ngIf="isLoading">
            <p>Loading model details...</p>
        </div>

        <!-- Error message if LIVE loading failed -->
        <div *ngIf="error" class="error">
            <p class="error">{{ error }}</p>
        </div>

        <!-- LIVE details -->
        <div *ngIf="!isLoading && !error && modelVersion">
            <p><strong>Base Model:</strong> {{ modelVersion.baseModel }}</p>
            <p><strong>Model Name:</strong> {{ modelVersion.model?.name }}</p>
            <p>
                <strong>Trained Words:</strong>
                <span *ngIf="modelVersion.trainedWords && modelVersion.trainedWords.length; else noTW">
                    {{ modelVersion.trainedWords.join(', ') }}
                </span>
                <ng-template #noTW>‚Äî</ng-template>
            </p>
            <p>
                <strong>Stats:</strong>
                Downloads: {{ modelVersion.stats?.downloadCount ?? '‚Äî' }},
                Thumbs Up: {{ modelVersion.stats?.thumbsUpCount ?? '‚Äî' }}
            </p>
        </div>

        <a *ngIf="linkModelId && linkVersionId" class="link-btn"
            [href]="'https://civitai.com/models/' + linkModelId + '?modelVersionId=' + linkVersionId" target="_blank"
            rel="noopener noreferrer" aria-label="Open model on Civitai (opens in new tab)">
            <!-- tiny external-link icon -->
            <svg class="icon" viewBox="0 0 24 24" width="16" height="16" aria-hidden="true">
                <path d="M14 3h7v7h-2V6.41l-9.29 9.3-1.42-1.42 9.3-9.29H14V3zM5 5h6v2H7v10h10v-4h2v6H5V5z" />
            </svg>
            Go to Model
        </a>



        <hr />

        <!-- Button to open the IN-SIDEBAR local overlay (unchanged) -->
        <div class="db-actions">
            <button class="db-button" (click)="openDbOverlay()">View Local Record</button>
        </div>
    </div>

    <!-- ===== IN-SIDEBAR bottom sheet overlay (unchanged) ===== -->
    <div class="db-panel-backdrop" *ngIf="dbOverlayOpen" (click)="$event.stopPropagation(); closeDbOverlay()"></div>

    <div class="db-panel" *ngIf="dbOverlayOpen" (click)="$event.stopPropagation()">
        <div class="db-panel-header">
            <h3>Local Record</h3>
            <button class="db-close" (click)="$event.stopPropagation(); closeDbOverlay()">‚úï</button>
        </div>

        <div class="db-panel-body">
            <div *ngIf="dbLoading" class="overlay-loading">Loading local record‚Ä¶</div>
            <div *ngIf="dbError" class="overlay-error">{{ dbError }}</div>

            <ng-container *ngIf="!dbLoading && !dbError && dbData">
                <!-- LOCAL carousel INSIDE sidebar overlay -->
                <div class="overlay-carousel" *ngIf="dbImages.length">
                    <button class="carousel-btn" (click)="prevDbImage()">&#10094;</button>
                    <!-- CLICK HERE opens the FULL-SCREEN overlay with LOCAL data -->
                    <img class="overlay-image" [src]="dbImages[dbImageIndex].url" alt="Local record image"
                        (click)="openFullOverlay('local', dbImageIndex)" />
                    <button class="carousel-btn" (click)="nextDbImage()">&#10095;</button>
                </div>

                <!-- Details grid -->
                <div class="overlay-grid">
                    <div class="row"><label>Category</label>
                        <div>{{ dbData?.model?.category }}</div>
                    </div>

                    <!-- My Rating (editable) -->
                    <div class="row" (dblclick)="startEditMyRating()">
                        <label>My Rating</label>
                        <div>
                            <!-- VIEW MODE -->
                            <ng-container *ngIf="!editingMyRating; else editRatingTpl">
                                <ng-container *ngIf="dbMyRating !== null; else noMyRatingFS">
                                    <span class="rating-text" title="Double-click to edit">{{ dbMyRating }} / 20</span>
                                    <div class="rating-bar" aria-hidden="true">
                                        <div class="rating-fill" [style.width.%]="(dbMyRating / 20) * 100"></div>
                                    </div>
                                </ng-container>
                                <ng-template #noMyRatingFS>
                                    <span class="muted" title="Double-click to set a rating">‚Äî</span>
                                </ng-template>
                            </ng-container>

                            <!-- EDIT MODE -->
                            <ng-template #editRatingTpl>
                                <div class="rating-edit">
                                    <input id="myRatingInput" type="number" min="0" max="20" [disabled]="savingMyRating"
                                        [(ngModel)]="myRatingInput" (keydown.enter)="saveMyRating()"
                                        (keydown.escape)="cancelMyRatingEdit()" />
                                    <button class="btn" [disabled]="savingMyRating"
                                        (click)="saveMyRating()">Save</button>
                                    <button class="btn secondary" [disabled]="savingMyRating"
                                        (click)="cancelMyRatingEdit()">Cancel</button>
                                </div>
                                <div class="field-error" *ngIf="myRatingError">{{ myRatingError }}</div>
                            </ng-template>
                        </div>
                    </div>

                    <div class="row"><label>Type</label>
                        <div>{{ dbData?.details?.type }}</div>
                    </div>
                    <div class="row"><label>Version #</label>
                        <div>{{ dbData?.model?.versionNumber }}</div>
                    </div>
                    <div class="row"><label>Model #</label>
                        <div>{{ dbData?.model?.modelNumber }}</div>
                    </div>
                    <div class="row"><label>Local Path</label>
                        <div class="mono">{{ dbData?.model?.localPath }}</div>
                    </div>
                    <div class="row"><label>Name</label>
                        <div>{{ dbData?.model?.name }}</div>
                    </div>
                    <div class="row"><label>Main Model Name</label>
                        <div>{{ dbData?.model?.mainModelName }}</div>
                    </div>

                    <div class="row">
                        <label>Tags</label>
                        <div>
                            <ng-container *ngIf="dbTags?.length; else noTags">
                                <span class="chip" *ngFor="let t of dbTags">{{ t }}</span>
                            </ng-container>
                            <ng-template #noTags>‚Äî</ng-template>
                        </div>
                    </div>

                    <div class="row">
                        <label>Trigger Words</label>
                        <div>
                            <ng-container *ngIf="dbTriggerWords?.length; else noTrig">
                                <span class="chip" *ngFor="let w of dbTriggerWords">{{ w }}</span>
                            </ng-container>
                            <ng-template #noTrig>‚Äî</ng-template>
                        </div>
                    </div>

                    <div class="row">
                        <label>Stats</label>
                        <div class="mono">
                            <ng-container *ngIf="dbStats; else noStats">
                                Downloads: {{ dbStats.downloadCount ?? '‚Äî' }} |
                                Rating: {{ dbStats.rating ?? '‚Äî' }} ({{ dbStats.ratingCount ?? '‚Äî' }}) |
                                üëç {{ dbStats.thumbsUpCount ?? '‚Äî' }}
                            </ng-container>
                            <ng-template #noStats>‚Äî</ng-template>
                        </div>
                    </div>

                    <!-- creator / urlAccessible / created / updated -->
                    <div class="row"><label>Creator</label>
                        <div>{{ dbCreator || '‚Äî' }}</div>
                    </div>

                    <div class="row">
                        <label>URL Accessible</label>
                        <div>
                            <span class="bool-pill" [class.true]="dbUrlAccessible === true"
                                [class.false]="dbUrlAccessible === false">
                                {{ dbUrlAccessible === true ? 'Yes' : (dbUrlAccessible === false ? 'No' : '‚Äî') }}
                            </span>
                        </div>
                    </div>

                    <div class="row"><label>Created</label>
                        <div>{{ dbCreatedAt | date:'medium' }}</div>
                    </div>
                    <div class="row"><label>Updated</label>
                        <div>{{ dbUpdatedAt | date:'medium' }}</div>
                    </div>
                </div>
            </ng-container>
        </div>
    </div>
</div>

<!-- ===== FULL-SCREEN bottom-sheet overlay (new) ===== -->
<div class="full-overlay-backdrop" *ngIf="fullOverlayOpen" (click)="$event.stopPropagation(); closeFullOverlay()"></div>

<div class="full-bottom-sheet" *ngIf="fullOverlayOpen" (click)="$event.stopPropagation()">
    <div class="sheet-header">
        <h3>{{ fullSource === 'local' ? 'Local Record' : 'Live Details' }}</h3>
        <button class="sheet-close" (click)="$event.stopPropagation(); closeFullOverlay()">‚úï</button>
    </div>

    <div class="sheet-body">
        <div *ngIf="fullLoading" class="overlay-loading">Loading‚Ä¶</div>
        <div *ngIf="fullError" class="overlay-error">{{ fullError }}</div>

        <ng-container *ngIf="!fullLoading && !fullError">
            <!-- A compact control row inside the full overlay -->
            <div class="row" *ngIf="fullImages?.length">
                <label>Images</label>
                <div>
                    <button (click)="toggleFullCarousel()">
                        {{ showFullCarousel ? 'Hide' : 'Show' }}
                    </button>
                </div>
            </div>

            <!-- source-aware carousel -->
            <div class="overlay-carousel" *ngIf="showFullCarousel && fullImages.length">
                <button class="carousel-btn" (click)="prevFullImage()">&#10094;</button>
                <!-- Full-screen overlay -->
                <img *ngIf="fullImages && fullImages.length > fullImageIndex" class="overlay-image"
                    [src]="fullImages[fullImageIndex].url" alt="image" loading="lazy" decoding="async"
                    fetchpriority="low" />

                <button class="carousel-btn" (click)="nextFullImage()">&#10095;</button>
            </div>


            <!-- LOCAL details in full-screen overlay -->
            <div class="overlay-grid" *ngIf="fullSource === 'local'">
                <!-- High-level meta -->
                <div class="row"><label>ID</label>
                    <div>{{ dbId || '‚Äî' }}</div>
                </div>
                <div class="row"><label>Name</label>
                    <div>{{ dbName }}</div>
                </div>
                <div class="row"><label>Main Model Name</label>
                    <div>{{ dbMainModelName }}</div>
                </div>
                <div class="row"><label>Local Path</label>
                    <div class="mono">{{ dbLocalPath }}</div>
                </div>
                <div class="row"><label>Category</label>
                    <div>{{ dbCategory }}</div>
                </div>

                <!-- Version / model numbers -->
                <div class="row"><label>Version #</label>
                    <div>{{ dbVersionNumber }}</div>
                </div>
                <div class="row"><label>Model #</label>
                    <div>{{ dbModelNumber }}</div>
                </div>

                <!-- Booleans -->
                <div class="row">
                    <label>NSFW</label>
                    <div>
                        <span class="bool-pill" [class.true]="dbNSFW === true" [class.false]="dbNSFW === false">
                            {{ dbNSFW === true ? 'Yes' : (dbNSFW === false ? 'No' : '‚Äî') }}
                        </span>
                    </div>
                </div>

                <div class="row">
                    <label>Flag</label>
                    <div>
                        <span class="bool-pill" [class.true]="dbFlag === true" [class.false]="dbFlag === false">
                            {{ dbFlag === true ? 'Yes' : (dbFlag === false ? 'No' : '‚Äî') }}
                        </span>
                    </div>
                </div>

                <div class="row">
                    <label>URL Accessible</label>
                    <div>
                        <span class="bool-pill" [class.true]="dbUrlAccessible === true"
                            [class.false]="dbUrlAccessible === false">
                            {{ dbUrlAccessible === true ? 'Yes' : (dbUrlAccessible === false ? 'No' : '‚Äî') }}
                        </span>
                    </div>
                </div>

                <!-- Details -->
                <div class="row"><label>Type</label>
                    <div>{{ dbType }}</div>
                </div>
                <div class="row"><label>Base Model</label>
                    <div>{{ dbBaseModelLocal }}</div>
                </div>
                <div class="row"><label>Uploaded</label>
                    <div>{{ dbUploaded }}</div>
                </div>
                <div class="row"><label>Creator</label>
                    <div>{{ dbCreator }}</div>
                </div>

                <!-- Dates -->
                <div class="row"><label>Created</label>
                    <div>{{ dbCreatedAt | date:'medium' }}</div>
                </div>
                <div class="row"><label>Updated</label>
                    <div>{{ dbUpdatedAt | date:'medium' }}</div>
                </div>

                <!-- Tags / Aliases / Trigger Words -->
                <div class="row">
                    <label>Tags</label>
                    <div>
                        <ng-container *ngIf="dbTags?.length; else noTagsFS">
                            <span class="chip" *ngFor="let t of dbTags">{{ t }}</span>
                        </ng-container>
                        <ng-template #noTagsFS>‚Äî</ng-template>
                    </div>
                </div>

                <div class="row">
                    <label>Local Tags</label>
                    <div>
                        <ng-container *ngIf="dbLocalTags?.length; else noLocalTagsFS">
                            <span class="chip" *ngFor="let t of dbLocalTags">{{ t }}</span>
                        </ng-container>
                        <ng-template #noLocalTagsFS>‚Äî</ng-template>
                    </div>
                </div>

                <div class="row">
                    <label>Aliases</label>
                    <div>
                        <ng-container *ngIf="dbAliases?.length; else noAliasesFS">
                            <span class="chip" *ngFor="let a of dbAliases">{{ a }}</span>
                        </ng-container>
                        <ng-template #noAliasesFS>‚Äî</ng-template>
                    </div>
                </div>

                <div class="row">
                    <label>Trigger Words</label>
                    <div>
                        <ng-container *ngIf="dbTriggerWords?.length; else noTrigFS">
                            <span class="chip" *ngFor="let w of dbTriggerWords">{{ w }}</span>
                        </ng-container>
                        <ng-template #noTrigFS>‚Äî</ng-template>
                    </div>
                </div>

                <!-- Stats -->
                <div class="row">
                    <label>Stats</label>
                    <div class="mono">
                        <ng-container *ngIf="dbStats; else noStatsFS">
                            Downloads: {{ dbStats.downloadCount ?? '‚Äî' }} |
                            Rating: {{ dbStats.rating ?? '‚Äî' }} ({{ dbStats.ratingCount ?? '‚Äî' }}) |
                            üëç {{ dbStats.thumbsUpCount ?? '‚Äî' }}
                        </ng-container>
                        <ng-template #noStatsFS>‚Äî</ng-template>
                    </div>
                </div>

                <!-- Hash (pretty list) -->
                <div class="row">
                    <label>Hash</label>
                    <div class="mono">
                        <ng-container *ngIf="dbHash; else noHashFS">
                            <div *ngFor="let h of dbHash | keyvalue">{{ h.key }}: {{ h.value }}</div>
                        </ng-container>
                        <ng-template #noHashFS>‚Äî</ng-template>
                    </div>
                </div>

                <!-- Usage Tips -->
                <div class="row">
                    <label>Usage Tips</label>
                    <div>{{ dbUsageTips || '‚Äî' }}</div>
                </div>

                <!-- URL (keep or remove as you like) -->
                <div class="row">
                    <label>URL</label>
                    <div>{{ dbUrl || '‚Äî' }}</div>
                </div>

                <!-- Description (HTML) -->
                <div class="row">
                    <label>Description</label>
                    <div *ngIf="dbDescriptionHtml; else noDescFS" [innerHTML]="dbDescriptionHtml"></div>
                    <ng-template #noDescFS>‚Äî</ng-template>
                </div>
            </div>

            <!-- Controls -->
            <div class="overlay-grid" *ngIf="fullSource === 'live'">
                <label>Raw JSON (Model)</label>
                <div>
                    <button (click)="showModelRaw = !showModelRaw">
                        {{ showModelRaw ? 'Hide' : 'Show' }}
                    </button>
                    <button *ngIf="showModelRaw && modelRawJson" (click)="copyModelRaw()">Copy</button>
                </div>
            </div>

            <!-- Display highlighted HTML -->
            <pre *ngIf="fullSource === 'live' && showModelRaw" class="json-pre" [innerHTML]="modelRawHtml"></pre>

            <!-- LIVE details in full-screen overlay -->
            <div class="overlay-grid" *ngIf="fullSource === 'live'">
                <!-- your existing summary fields stay here ... -->

                <!-- Raw JSON controls -->
                <div class="row">
                    <label>Raw JSON (Version API)</label>
                    <div>
                        <button (click)="toggleLiveRawJson()">
                            {{ showLiveRaw ? 'Hide' : 'Show' }}
                        </button>
                        <button *ngIf="showLiveRaw && liveRawJson" (click)="copyLiveRawJson()">
                            Copy
                        </button>
                    </div>
                </div>
            </div>

            <!-- Full-width pretty JSON block (outside the grid for better width) -->
            <pre *ngIf="fullSource === 'live' && showLiveRaw" class="json-pre">{{ liveRawJson }}</pre>

        </ng-container>
    </div>
</div>