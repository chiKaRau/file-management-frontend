<div class="sidebar">
    <div class="header">
        <h3>Details</h3>
        <button (click)="close()">X</button>
    </div>

    <div *ngIf="item" class="content">
        <!-- LIVE (Civitai) mini carousel -->
        <div class="carousel">
            <button class="carousel-btn" (click)="prevImage()"
                [disabled]="!(modelVersion?.images?.length > 1)">&#10094;</button>
            <!-- NOTE: keep openModal() in template; we'll repurpose it in TS to open full-screen overlay -->
            <!-- Sidebar mini carousel -->
            <img class="carousel-image" [src]="currentImageUrl" alt="Model Image" loading="lazy" decoding="async"
                fetchpriority="low" (click)="openModal()" />

            <button class="carousel-btn" (click)="nextImage()"
                [disabled]="!(modelVersion?.images?.length > 1)">&#10095;</button>
        </div>

        <p><strong>Name:</strong> {{ item.name }}</p>

        <!-- My Rating (10 stars, half-steps) -->
        <div class="row">
            <label>My Rating</label>

            <div class="stars" [class.saving]="savingMyRating" (mouseleave)="hoverRating = null">
                <button class="star-btn" type="button" *ngFor="let _ of ten; let i = index"
                    (mousemove)="onStarHover($event, i)" (touchstart)="onStarTouch($event, i)"
                    (click)="onStarClick($event, i)" [disabled]="savingMyRating" [attr.aria-label]="starAriaLabel(i)">
                    <span class="star">
                        <!-- base (empty) star -->
                        <svg class="base" viewBox="0 0 24 24" aria-hidden="true">
                            <path
                                d="M12 17.27 18.18 21l-1.64-7.03L22 9.24l-7.19-.62L12 2 9.19 8.62 2 9.24l5.46 4.73L5.82 21z" />
                        </svg>

                        <!-- filled part clipped by width% -->
                        <span class="fillwrap" [style.width.%]="starFillPct(i)">
                            <svg class="fill" viewBox="0 0 24 24" aria-hidden="true">
                                <path
                                    d="M12 17.27 18.18 21l-1.64-7.03L22 9.24l-7.19-.62L12 2 9.19 8.62 2 9.24l5.46 4.73L5.82 21z" />
                            </svg>
                        </span>
                    </span>
                </button>

                <span class="rating-value">{{ effectiveRating }} / 20</span>
            </div>

            <div class="field-error" *ngIf="myRatingError">{{ myRatingError }}</div>
        </div>

        <p><strong>Path:</strong> {{ item.path }}</p>

        <!-- URL (click to copy) -->
        <p *ngIf="modelUrl as url">
            <strong>URL:</strong>
            <span class="mono linklike" title="Click to copy" (click)="copyText(url)">
                {{ url }}
            </span>
            <button class="btn btn--ghost btn--sm" (click)="copyText(url)">Copy</button>
        </p>

        <p><strong>Type:</strong> {{ item.isDirectory ? 'Folder' : 'File' }}</p>

        <!-- Spinner when loading LIVE -->
        <div *ngIf="isLoading">
            <p>Loading model details...</p>
        </div>

        <!-- Error message if LIVE loading failed -->
        <div *ngIf="error" class="error">
            <p class="error">{{ error }}</p>
        </div>

        <!-- LIVE details -->
        <div *ngIf="!isLoading && !error && modelVersion">
            <p><strong>Base Model:</strong> {{ modelVersion.baseModel }}</p>
            <p><strong>Model Name:</strong> {{ modelVersion.model?.name }}</p>
            <p>
                <strong>Trained Words:</strong>
                <span *ngIf="modelVersion.trainedWords && modelVersion.trainedWords.length; else noTW">
                    {{ modelVersion.trainedWords.join(', ') }}
                </span>
                <ng-template #noTW>—</ng-template>
            </p>
            <p>
                <strong>Stats:</strong>
                Downloads: {{ modelVersion.stats?.downloadCount ?? '—' }},
                Thumbs Up: {{ modelVersion.stats?.thumbsUpCount ?? '—' }}
            </p>
        </div>

        <a *ngIf="linkModelId && linkVersionId" class="link-btn"
            [href]="'https://civitai.com/models/' + linkModelId + '?modelVersionId=' + linkVersionId" target="_blank"
            rel="noopener noreferrer" aria-label="Open model on Civitai (opens in new tab)">
            <!-- tiny external-link icon -->
            <svg class="icon" viewBox="0 0 24 24" width="16" height="16" aria-hidden="true">
                <path d="M14 3h7v7h-2V6.41l-9.29 9.3-1.42-1.42 9.3-9.29H14V3zM5 5h6v2H7v10h10v-4h2v6H5V5z" />
            </svg>
            Go to Model
        </a>

        <hr />

        <!-- Button to open the IN-SIDEBAR local overlay (unchanged) -->
        <div class="db-actions btn-group">
            <button class="db-button btn--sm" (click)="openDbOverlay()">View Local Record</button>
            <button class="db-button btn--sm" (click)="openSibOverlay()">View DB Siblings</button>
            <button class="db-button btn--sm" (click)="openSimOverlay()">Search similar in DB</button>
        </div>


    </div>

    <!-- ===== IN-SIDEBAR bottom sheet overlay (unchanged) ===== -->
    <div class="db-panel-backdrop" *ngIf="dbOverlayOpen" (click)="$event.stopPropagation(); closeDbOverlay()"></div>

    <div class="db-panel" *ngIf="dbOverlayOpen" (click)="$event.stopPropagation()">
        <div class="db-panel-header">
            <h3>Local Record</h3>
            <button class="db-close" (click)="$event.stopPropagation(); closeDbOverlay()">✕</button>
        </div>

        <div class="db-panel-body">
            <div *ngIf="dbLoading" class="overlay-loading">Loading local record…</div>
            <div *ngIf="dbError" class="overlay-error">{{ dbError }}</div>

            <ng-container *ngIf="!dbLoading && !dbError && dbData">
                <!-- LOCAL carousel INSIDE sidebar overlay -->
                <div class="overlay-carousel" *ngIf="dbImages.length">
                    <button class="carousel-btn" (click)="prevDbImage()">&#10094;</button>
                    <!-- CLICK HERE opens the FULL-SCREEN overlay with LOCAL data -->
                    <img class="overlay-image" [src]="dbImages[dbImageIndex].url" alt="Local record image"
                        (click)="openFullOverlay('local', dbImageIndex)" />
                    <button class="carousel-btn" (click)="nextDbImage()">&#10095;</button>
                </div>

                <!-- Details grid -->
                <div class="overlay-grid">

                    <!-- My Rating (10 stars, half-steps) -->
                    <div class="row">
                        <label>My Rating</label>

                        <div class="stars" [class.saving]="savingMyRating" (mouseleave)="hoverRating = null">
                            <button class="star-btn" type="button" *ngFor="let _ of ten; let i = index"
                                (mousemove)="onStarHover($event, i)" (touchstart)="onStarTouch($event, i)"
                                (click)="onStarClick($event, i)" [disabled]="savingMyRating"
                                [attr.aria-label]="starAriaLabel(i)">
                                <span class="star">
                                    <!-- base (empty) star -->
                                    <svg class="base" viewBox="0 0 24 24" aria-hidden="true">
                                        <path
                                            d="M12 17.27 18.18 21l-1.64-7.03L22 9.24l-7.19-.62L12 2 9.19 8.62 2 9.24l5.46 4.73L5.82 21z" />
                                    </svg>

                                    <!-- filled part clipped by width% -->
                                    <span class="fillwrap" [style.width.%]="starFillPct(i)">
                                        <svg class="fill" viewBox="0 0 24 24" aria-hidden="true">
                                            <path
                                                d="M12 17.27 18.18 21l-1.64-7.03L22 9.24l-7.19-.62L12 2 9.19 8.62 2 9.24l5.46 4.73L5.82 21z" />
                                        </svg>
                                    </span>
                                </span>
                            </button>

                            <span class="rating-value">{{ effectiveRating }} / 20</span>
                        </div>

                        <div class="field-error" *ngIf="myRatingError">{{ myRatingError }}</div>
                    </div>

                    <div class="row"><label>Category</label>
                        <div>{{ dbData?.model?.category }}</div>
                    </div>

                    <div class="row"><label>Type</label>
                        <div>{{ dbData?.details?.type }}</div>
                    </div>
                    <div class="row"><label>Model #</label>
                        <div>{{ dbData?.model?.modelNumber }}</div>
                    </div>
                    <div class="row"><label>Version #</label>
                        <div>{{ dbData?.model?.versionNumber }}</div>
                    </div>
                    <div class="row">
                        <label>Local Path</label>
                        <div class="mono linklike" (click)="$event.stopPropagation(); revealLocalPath()"
                            title="Open in file explorer">
                            {{ dbLocalPath }}
                        </div>
                        <button class="btn btn--ghost btn--sm"
                            (click)="$event.stopPropagation(); copyText(dbLocalPath)">
                            Copy
                        </button>
                    </div>

                    <div class="row"><label>Name</label>
                        <div>{{ dbData?.model?.name }}</div>
                    </div>
                    <div class="row"><label>Main Model Name</label>
                        <div>{{ dbData?.model?.mainModelName }}</div>
                    </div>

                    <div class="row">
                        <label>Tags</label>
                        <div>
                            <ng-container *ngIf="dbTags?.length; else noTags">
                                <span class="chip" *ngFor="let t of dbTags">{{ t }}</span>
                            </ng-container>
                            <ng-template #noTags>—</ng-template>
                        </div>
                    </div>

                    <div class="row">
                        <label>Trigger Words</label>
                        <div>
                            <ng-container *ngIf="dbTriggerWords?.length; else noTrig">
                                <span class="chip" *ngFor="let w of dbTriggerWords">{{ w }}</span>
                            </ng-container>
                            <ng-template #noTrig>—</ng-template>
                        </div>
                    </div>

                    <div class="row">
                        <label>Stats</label>
                        <div class="mono">
                            <ng-container *ngIf="dbStats; else noStats">
                                Downloads: {{ dbStats.downloadCount ?? '—' }} |
                                Rating: {{ dbStats.rating ?? '—' }} ({{ dbStats.ratingCount ?? '—' }}) |
                                👍 {{ dbStats.thumbsUpCount ?? '—' }}
                            </ng-container>
                            <ng-template #noStats>—</ng-template>
                        </div>
                    </div>

                    <!-- creator / urlAccessible / created / updated -->
                    <div class="row"><label>Creator</label>
                        <div>{{ dbCreator || '—' }}</div>
                    </div>

                    <div class="row">
                        <label>URL Accessible</label>
                        <div>
                            <span class="bool-pill" [class.true]="dbUrlAccessible === true"
                                [class.false]="dbUrlAccessible === false">
                                {{ dbUrlAccessible === true ? 'Yes' : (dbUrlAccessible === false ? 'No' : '—') }}
                            </span>
                        </div>
                    </div>

                    <div class="row"><label>Created</label>
                        <div>{{ dbCreatedAt | date:'medium' }}</div>
                    </div>
                    <div class="row"><label>Updated</label>
                        <div>{{ dbUpdatedAt | date:'medium' }}</div>
                    </div>
                </div>
            </ng-container>
        </div>
    </div>

    <!-- ===== IN-SIDEBAR "Search Similar" overlay (same look as Local) ===== -->
    <div class="db-panel-backdrop" *ngIf="simOverlayOpen" (click)="$event.stopPropagation(); closeSimOverlay()"></div>

    <div class="db-panel" *ngIf="simOverlayOpen" (click)="$event.stopPropagation()">
        <div class="db-panel-header">
            <h3>Search Similar</h3>

            <!-- modern close button, reusing .btn styles -->
            <button class="db-close btn btn--icon" aria-label="Close"
                (click)="$event.stopPropagation(); closeSimOverlay()">
                ✕
            </button>
        </div>

        <div class="db-panel-body">
            <div class="overlay-grid">
                <!-- Input as source of truth -->
                <div class="row">
                    <label>Query</label>
                    <div>
                        <input type="text" [(ngModel)]="simInput" (ngModelChange)="syncSelectionFromInput()"
                            placeholder="type or click tags… (space-separated)" />
                        <div class="input-hint">Selected tags appear here. Press space to separate.</div>
                    </div>
                </div>

                <!-- Suggestions (single-word, de-duplicated) -->
                <div class="row">
                    <label>Suggestions</label>
                    <div>
                        <ng-container *ngIf="simAvailableTokens?.length; else noSimTags">
                            <span *ngFor="let t of simAvailableTokens" class="chip chip--selectable"
                                [class.chip--active]="isTokenSelected(t)" (click)="toggleToken(t)">
                                {{ t }}
                            </span>
                        </ng-container>
                        <ng-template #noSimTags>—</ng-template>
                    </div>
                </div>

                <!-- Actions -->
                <div class="row">
                    <label></label>
                    <div class="btn-group">
                        <button class="btn btn--primary btn--sm" (click)="submitSimilar()"
                            [disabled]="!hasAnyInputTokens || simLoading">
                            {{ simLoading ? 'Searching…' : 'Submit Tags' }}
                        </button>
                        <button class="btn btn--ghost btn--sm" (click)="clearSimilar()" [disabled]="simLoading">
                            Clear
                        </button>
                    </div>
                </div>

                <!-- Base Model filter bar -->
                <div class="sim-filterbar" *ngIf="simBaseModelLabels.length">
                    <div class="sim-filter-title">Filter by Base Model</div>

                    <div class="sim-filter-group">
                        <label class="sim-filter-chip" *ngFor="let opt of simBaseModelLabels; trackBy: trackByKey">
                            <input type="checkbox" [checked]="isBaseModelSelected(opt.key)"
                                (change)="onBaseModelCheckboxChange(opt.key, $event)" />
                            <span>{{ opt.label }}</span>
                        </label>
                    </div>


                    <div class="btn-group">
                        <button class="btn btn--ghost btn--sm" (click)="selectAllBaseModels()">Select all</button>
                        <button class="btn btn--ghost btn--sm" (click)="clearBaseModels()">Clear</button>
                    </div>
                </div>

                <!-- Results list (now filtered + sorted) -->
                <ng-container *ngIf="filteredAndSortedSimResults.length; else simNoResults">
                    <div class="sim-card-grid">
                        <div class="card-slot" *ngFor="let m of filteredAndSortedSimResults; let i = index">
                            <div class="file-card">
                                <!-- Mini carousel per card -->
                                <div class="mini-carousel" *ngIf="simImageCount(m) > 0">
                                    <button class="carousel-btn mini" (click)="prevSimImage(m, $event)"
                                        [disabled]="simImageCount(m) < 2">&#10094;</button>

                                    <img class="mini-image" [src]="simCurrentImage(m)"
                                        [alt]="m.mainModelName || 'Preview image'" loading="lazy" decoding="async"
                                        fetchpriority="low" />

                                    <button class="carousel-btn mini" (click)="nextSimImage(m, $event)"
                                        [disabled]="simImageCount(m) < 2">&#10095;</button>
                                </div>

                                <!-- badges + footer stay the same -->
                                <div class="badge top-left">ID: {{ m.modelNumber }} / {{ m.versionNumber }}</div>
                                <div class="badge top-right">{{ m.baseModel || 'N/A' }}</div>

                                <div class="card-footer">
                                    <div class="creator">{{ m.creatorName || '—' }}</div>
                                    <div class="main-model">{{ m.mainModelName || 'N/A' }}</div>
                                    <ng-container *ngIf="simGetParsedStats(m) as stats">
                                        <div class="stats">
                                            <span><span class="material-icons icon-download">file_download</span>{{
                                                stats?.downloadCount ?? 'N/A' }}</span>
                                            <span><span class="material-icons icon-rating-count">rate_review</span>{{
                                                stats?.ratingCount ?? 'N/A' }}</span>
                                            <span><span class="material-icons icon-rating">star_rate</span>{{
                                                stats?.rating ?? 'N/A' }}</span>
                                            <span><span class="material-icons icon-thumb-up">thumb_up</span>{{
                                                stats?.thumbsUpCount ?? 'N/A' }}</span>
                                        </div>
                                    </ng-container>
                                    <div class="size-line">
                                        <span class="material-icons">sd_storage</span>
                                        <span class="size-text">N/A</span>
                                    </div>
                                </div>

                                <ng-container *ngIf="simGetMyRating(m) as r">
                                    <div class="rating-star" *ngIf="r > 0" [attr.title]="r + ' / 20'">
                                        <svg viewBox="0 0 24 24" aria-hidden="true">
                                            <path
                                                d="M12 17.27 18.18 21l-1.64-7.03L22 9.24l-7.19-.62L12 2 9.19 8.62 2 9.24l5.46 4.73L5.82 21z" />
                                        </svg>
                                        <div class="star-number">{{ r }}</div>
                                    </div>
                                </ng-container>
                            </div>


                            <ng-container *ngIf="simGetMyRating(m) as r">
                                <div class="rating-star" *ngIf="r > 0" [attr.title]="r + ' / 20'">
                                    <svg viewBox="0 0 24 24" aria-hidden="true">
                                        <path
                                            d="M12 17.27 18.18 21l-1.64-7.03L22 9.24l-7.19-.62L12 2 9.19 8.62 2 9.24l5.46 4.73L5.82 21z" />
                                    </svg>
                                    <div class="star-number">{{ r }}</div>
                                </div>
                            </ng-container>
                        </div>
                    </div>
                </ng-container>

                <ng-template #simNoResults>
                    <div class="overlay-loading">No results yet — choose tags and Submit.</div>
                </ng-template>

                <ng-template #noSimBlock>
                    <div class="overlay-loading" *ngIf="noBaseModelSelected">
                        No base models selected — pick at least one.
                    </div>
                    <div class="overlay-loading" *ngIf="!noBaseModelSelected">
                        No results yet — choose tags and Submit.
                    </div>
                </ng-template>

                <!-- Result / error hint -->
                <div class="row" *ngIf="simError">
                    <label></label>
                    <div class="overlay-error">{{ simError }}</div>
                </div>
            </div>
        </div>

    </div>

    <!-- ===== IN-SIDEBAR "DB Siblings" overlay ===== -->
    <div class="db-panel-backdrop" *ngIf="sibOverlayOpen" (click)="$event.stopPropagation(); closeSibOverlay()"></div>

    <div class="db-panel" *ngIf="sibOverlayOpen" (click)="$event.stopPropagation()">
        <div class="db-panel-header">
            <h3>DB Siblings</h3>
            <button class="db-close btn btn--icon" aria-label="Close"
                (click)="$event.stopPropagation(); closeSibOverlay()">✕</button>
        </div>

        <div class="db-panel-body">
            <div *ngIf="sibLoading" class="overlay-loading">Loading siblings…</div>
            <div *ngIf="sibError" class="overlay-error">{{ sibError }}</div>

            <ng-container *ngIf="!sibLoading && !sibError">
                <!-- Base Model filter bar -->
                <div class="sim-filterbar" *ngIf="sibBaseModelLabels.length">
                    <div class="sim-filter-title">Filter by Base Model</div>

                    <div class="sim-filter-group">
                        <label class="sim-filter-chip" *ngFor="let opt of sibBaseModelLabels; trackBy: trackByKey">
                            <input type="checkbox" [checked]="isSibBaseModelSelected(opt.key)"
                                (change)="onSibBaseModelCheckboxChange(opt.key, $event)" />
                            <span>{{ opt.label }}</span>
                        </label>
                    </div>

                    <div class="btn-group">
                        <button class="btn btn--ghost btn--sm" (click)="selectAllSibBaseModels()">Select all</button>
                        <button class="btn btn--ghost btn--sm" (click)="clearSibBaseModels()">Clear</button>
                    </div>
                </div>

                <!-- Results -->
                <ng-container *ngIf="filteredAndSortedSibResults.length; else sibNoResults">
                    <div class="sim-card-grid">
                        <div class="card-slot"
                            *ngFor="let m of filteredAndSortedSibResults; let i = index; trackBy: simTrackBy">
                            <div class="file-card">
                                <!-- Mini carousel per card -->
                                <div class="mini-carousel" *ngIf="sibImageCount(m) > 0">
                                    <button class="carousel-btn mini" (click)="prevSibImage(m, $event)"
                                        [disabled]="sibImageCount(m) < 2">&#10094;</button>

                                    <img class="mini-image" [src]="sibCurrentImage(m)"
                                        [alt]="m.mainModelName || 'Preview image'" loading="lazy" decoding="async"
                                        fetchpriority="low" />

                                    <button class="carousel-btn mini" (click)="nextSibImage(m, $event)"
                                        [disabled]="sibImageCount(m) < 2">&#10095;</button>
                                </div>

                                <!-- badges + footer consistent with sim cards -->
                                <div class="badge top-left">ID: {{ m.modelNumber }} / {{ m.versionNumber }}</div>
                                <div class="badge top-right">{{ m.baseModel || 'N/A' }}</div>

                                <div class="card-footer">
                                    <div class="creator">{{ m.creatorName || '—' }}</div>
                                    <div class="main-model">{{ m.mainModelName || 'N/A' }}</div>
                                    <ng-container *ngIf="simGetParsedStats(m) as stats">
                                        <div class="stats">
                                            <span><span class="material-icons icon-download">file_download</span>{{
                                                stats?.downloadCount ?? 'N/A' }}</span>
                                            <span><span class="material-icons icon-rating-count">rate_review</span>{{
                                                stats?.ratingCount ?? 'N/A' }}</span>
                                            <span><span class="material-icons icon-rating">star_rate</span>{{
                                                stats?.rating ?? 'N/A' }}</span>
                                            <span><span class="material-icons icon-thumb-up">thumb_up</span>{{
                                                stats?.thumbsUpCount ?? 'N/A' }}</span>
                                        </div>
                                    </ng-container>
                                    <div class="size-line">
                                        <span class="material-icons">sd_storage</span>
                                        <span class="size-text">N/A</span>
                                    </div>
                                </div>

                                <ng-container *ngIf="simGetMyRating(m) as r">
                                    <div class="rating-star" *ngIf="r > 0" [attr.title]="r + ' / 20'">
                                        <svg viewBox="0 0 24 24" aria-hidden="true">
                                            <path
                                                d="M12 17.27 18.18 21l-1.64-7.03L22 9.24l-7.19-.62L12 2 9.19 8.62 2 9.24l5.46 4.73L5.82 21z" />
                                        </svg>
                                        <div class="star-number">{{ r }}</div>
                                    </div>
                                </ng-container>
                            </div>
                        </div>
                    </div>
                </ng-container>

                <ng-template #sibNoResults>
                    <div class="overlay-loading" *ngIf="sibNoBaseModelSelected">
                        No base models selected — pick at least one.
                    </div>
                    <div class="overlay-loading" *ngIf="!sibNoBaseModelSelected">
                        No results found for this model.
                    </div>
                </ng-template>
            </ng-container>
        </div>
    </div>

</div>




<!-- ===== FULL-SCREEN bottom-sheet overlay (new) ===== -->
<div class="full-overlay-backdrop" *ngIf="fullOverlayOpen" (click)="$event.stopPropagation(); closeFullOverlay()"></div>

<div class="full-bottom-sheet" *ngIf="fullOverlayOpen" (click)="$event.stopPropagation()">
    <div class="sheet-header">
        <h3>{{ fullSource === 'local' ? 'Local Record' : 'Live Details' }}</h3>

        <div *ngIf="fullSource === 'local'" class="btn-group">
            <button *ngIf="!editing" (click)="startEdit()" class="btn btn--outline btn--sm">Edit</button>
            <button *ngIf="editing" (click)="saveEdit()" [disabled]="savingEdit"
                class="btn btn--primary btn--sm">Save</button>
            <button *ngIf="editing" (click)="cancelEdit()" [disabled]="savingEdit"
                class="btn btn--ghost btn--sm">Cancel</button>
            <button *ngIf="editing" (click)="syncFromAPI()" [disabled]="syncingFromAPI || !canSyncNow || !!error"
                class="btn btn--outline btn--sm" [title]="!canSyncNow ? 'Open Local Record first' : ''">
                {{ syncingFromAPI ? 'Syncing…' : 'Sync From Civitai API' }}
            </button>
        </div>

        <button class="sheet-close" (click)="$event.stopPropagation(); closeFullOverlay()">✕</button>
    </div>


    <div class="sheet-body">
        <div *ngIf="fullLoading" class="overlay-loading">Loading…</div>
        <div *ngIf="fullError" class="overlay-error">{{ fullError }}</div>

        <ng-container *ngIf="!fullLoading && !fullError">
            <!-- A compact control row inside the full overlay -->
            <div class="row" *ngIf="fullImages?.length">
                <label>Images</label>
                <div>
                    <button (click)="toggleFullCarousel()" class="btn btn--ghost btn--sm">
                        {{ showFullCarousel ? 'Hide' : 'Show' }}
                    </button>
                </div>
            </div>


            <!-- source-aware carousel -->
            <div class="overlay-carousel" *ngIf="showFullCarousel && fullImages.length">
                <button class="carousel-btn" (click)="prevFullImage()">&#10094;</button>
                <!-- Full-screen overlay -->
                <img *ngIf="fullImages && fullImages.length > fullImageIndex" class="overlay-image"
                    [src]="fullImages[fullImageIndex].url" alt="image" loading="lazy" decoding="async"
                    fetchpriority="low" />

                <button class="carousel-btn" (click)="nextFullImage()">&#10095;</button>
            </div>


            <!-- LOCAL details in full-screen overlay -->
            <div class="overlay-grid" *ngIf="fullSource === 'local'">
                <!-- High-level meta -->
                <div class="row"><label>ID</label>
                    <div>{{ dbId || '—' }}</div>
                </div>
                <!-- Name -->
                <div class="row">
                    <label>Name</label>
                    <div *ngIf="!editing">{{ dbName }}</div>
                    <div *ngIf="editing">
                        <input type="text" [(ngModel)]="editForm.name" />
                    </div>
                </div>

                <!-- My Rating (10 stars, half-steps) -->
                <div class="row">
                    <label>My Rating</label>

                    <div class="stars" [class.saving]="savingMyRating" (mouseleave)="hoverRating = null">
                        <button class="star-btn" type="button" *ngFor="let _ of ten; let i = index"
                            (mousemove)="onStarHover($event, i)" (touchstart)="onStarTouch($event, i)"
                            (click)="onStarClick($event, i)" [disabled]="savingMyRating"
                            [attr.aria-label]="starAriaLabel(i)">
                            <span class="star">
                                <!-- base (empty) star -->
                                <svg class="base" viewBox="0 0 24 24" aria-hidden="true">
                                    <path
                                        d="M12 17.27 18.18 21l-1.64-7.03L22 9.24l-7.19-.62L12 2 9.19 8.62 2 9.24l5.46 4.73L5.82 21z" />
                                </svg>

                                <!-- filled part clipped by width% -->
                                <span class="fillwrap" [style.width.%]="starFillPct(i)">
                                    <svg class="fill" viewBox="0 0 24 24" aria-hidden="true">
                                        <path
                                            d="M12 17.27 18.18 21l-1.64-7.03L22 9.24l-7.19-.62L12 2 9.19 8.62 2 9.24l5.46 4.73L5.82 21z" />
                                    </svg>
                                </span>
                            </span>
                        </button>

                        <span class="rating-value">{{ effectiveRating }} / 20</span>
                    </div>

                    <div class="field-error" *ngIf="myRatingError">{{ myRatingError }}</div>
                </div>

                <!-- Main Model Name -->
                <div class="row">
                    <label>Main Model Name</label>
                    <div *ngIf="!editing">{{ dbMainModelName }}</div>
                    <div *ngIf="editing">
                        <input type="text" [(ngModel)]="editForm.mainModelName" />
                    </div>
                </div>

                <!-- Category -->
                <div class="row">
                    <label>Category</label>
                    <div *ngIf="!editing">{{ dbCategory }}</div>
                    <div *ngIf="editing">
                        <input type="text" [(ngModel)]="editForm.category" />
                    </div>
                </div>

                <!-- Local Path -->
                <div class="row">
                    <label>Local Path</label>
                    <div *ngIf="!editing" class="mono">{{ dbLocalPath }}</div>
                    <div *ngIf="editing">
                        <input type="text" [(ngModel)]="editForm.localPath" />
                    </div>
                </div>

                <!-- Version / Model # (read-only) -->
                <div class="row"><label>Version #</label>
                    <div>{{ dbVersionNumber }}</div>
                </div>
                <div class="row"><label>Model #</label>
                    <div>{{ dbModelNumber }}</div>
                </div>

                <!-- Booleans -->
                <div class="row">
                    <label>NSFW</label>
                    <div *ngIf="!editing">
                        <span class="bool-pill" [class.true]="dbNSFW === true" [class.false]="dbNSFW === false">
                            {{ dbNSFW === true ? 'Yes' : (dbNSFW === false ? 'No' : '—') }}
                        </span>
                    </div>
                    <div *ngIf="editing">
                        <input type="checkbox" [(ngModel)]="editForm.nsfw" />
                    </div>
                </div>

                <div class="row">
                    <label>Flag</label>
                    <div *ngIf="!editing">
                        <span class="bool-pill" [class.true]="dbFlag === true" [class.false]="dbFlag === false">
                            {{ dbFlag === true ? 'Yes' : (dbFlag === false ? 'No' : '—') }}
                        </span>
                    </div>
                    <div *ngIf="editing">
                        <input type="checkbox" [(ngModel)]="editForm.flag" />
                    </div>
                </div>

                <div class="row">
                    <label>URL Accessible</label>
                    <div *ngIf="!editing">
                        <span class="bool-pill" [class.true]="dbUrlAccessible === true"
                            [class.false]="dbUrlAccessible === false">
                            {{ dbUrlAccessible === true ? 'Yes' : (dbUrlAccessible === false ? 'No' : '—') }}
                        </span>
                    </div>
                    <div *ngIf="editing">
                        <input type="checkbox" [(ngModel)]="editForm.urlAccessable" />
                    </div>
                </div>

                <!-- Details -->
                <!-- Type -->
                <div class="row">
                    <label>Type</label>
                    <div *ngIf="!editing">{{ dbType }}</div>
                    <div *ngIf="editing">
                        <input type="text" [(ngModel)]="editForm.type" />
                    </div>
                </div>

                <!-- Base Model -->
                <div class="row">
                    <label>Base Model</label>
                    <div *ngIf="!editing">{{ dbBaseModelLocal }}</div>
                    <div *ngIf="editing">
                        <input type="text" [(ngModel)]="editForm.baseModel" />
                    </div>
                </div>

                <!-- Uploaded -->
                <div class="row">
                    <label>Uploaded</label>
                    <div *ngIf="!editing">{{ dbUploaded }}</div>
                    <div *ngIf="editing">
                        <input type="date" [(ngModel)]="editForm.uploaded" />
                    </div>
                </div>

                <!-- Creator -->
                <div class="row">
                    <label>Creator</label>
                    <div *ngIf="!editing">{{ dbCreator }}</div>
                    <div *ngIf="editing">
                        <input type="text" [(ngModel)]="editForm.creatorName" />
                    </div>
                </div>

                <!-- Dates -->
                <div class="row"><label>Created</label>
                    <div>{{ dbCreatedAt | date:'medium' }}</div>
                </div>
                <div class="row"><label>Updated</label>
                    <div>{{ dbUpdatedAt | date:'medium' }}</div>
                </div>

                <!-- Tags / Aliases / Trigger Words -->
                <div class="row">
                    <label>Tags (JSON)</label>
                    <div *ngIf="!editing">
                        <ng-container *ngIf="dbTags?.length; else noTagsFS">
                            <span class="chip" *ngFor="let t of dbTags">{{ t }}</span>
                        </ng-container>
                        <ng-template #noTagsFS>—</ng-template>
                    </div>
                    <div *ngIf="editing">
                        <textarea rows="3" [(ngModel)]="editForm.tags" class="json-input"></textarea>
                    </div>
                </div>

                <div class="row">
                    <label>Local Tags (JSON)</label>
                    <div *ngIf="!editing">
                        <ng-container *ngIf="dbLocalTags?.length; else noLocalTagsFS">
                            <span class="chip" *ngFor="let t of dbLocalTags">{{ t }}</span>
                        </ng-container>
                        <ng-template #noLocalTagsFS>—</ng-template>
                    </div>
                    <div *ngIf="editing">
                        <textarea rows="3" [(ngModel)]="editForm.localTags" class="json-input"></textarea>
                    </div>
                </div>

                <!-- Aliases JSON -->
                <div class="row">
                    <label>Aliases (JSON)</label>
                    <div *ngIf="!editing">
                        <ng-container *ngIf="dbAliases?.length; else noAliasesFS">
                            <span class="chip" *ngFor="let a of dbAliases">{{ a }}</span>
                        </ng-container>
                        <ng-template #noAliasesFS>—</ng-template>
                    </div>
                    <div *ngIf="editing">
                        <textarea rows="3" [(ngModel)]="editForm.aliases" class="json-input"></textarea>
                    </div>
                </div>

                <!-- Trigger Words JSON -->
                <div class="row">
                    <label>Trigger Words (JSON)</label>
                    <div *ngIf="!editing">
                        <ng-container *ngIf="dbTriggerWords?.length; else noTrigFS">
                            <span class="chip" *ngFor="let w of dbTriggerWords">{{ w }}</span>
                        </ng-container>
                        <ng-template #noTrigFS>—</ng-template>
                    </div>
                    <div *ngIf="editing">
                        <textarea rows="2" [(ngModel)]="editForm.triggerWords" class="json-input"></textarea>
                    </div>
                </div>

                <!-- Stats JSON -->
                <div class="row">
                    <label>Stats (JSON)</label>
                    <div *ngIf="!editing" class="mono">
                        <ng-container *ngIf="dbStats; else noStatsFS">
                            Downloads: {{ dbStats.downloadCount ?? '—' }} |
                            Rating: {{ dbStats.rating ?? '—' }} ({{ dbStats.ratingCount ?? '—' }}) |
                            👍 {{ dbStats.thumbsUpCount ?? '—' }}
                        </ng-container>
                        <ng-template #noStatsFS>—</ng-template>
                    </div>
                    <div *ngIf="editing">
                        <textarea rows="3" [(ngModel)]="editForm.stats" class="json-input"></textarea>
                    </div>
                </div>

                <!-- Hash JSON -->
                <div class="row">
                    <label>Hash (JSON)</label>
                    <div *ngIf="!editing" class="mono">
                        <ng-container *ngIf="dbHash; else noHashFS">
                            <div *ngFor="let h of dbHash | keyvalue">{{ h.key }}: {{ h.value }}</div>
                        </ng-container>
                        <ng-template #noHashFS>—</ng-template>
                    </div>
                    <div *ngIf="editing">
                        <textarea rows="3" [(ngModel)]="editForm.hash" class="json-input"></textarea>
                    </div>
                </div>

                <!-- Usage Tips -->
                <div class="row">
                    <label>Usage Tips</label>
                    <div *ngIf="!editing">{{ dbUsageTips || '-' }}</div>
                    <div *ngIf="editing">
                        <textarea rows="3" [(ngModel)]="editForm.usageTips"></textarea>
                    </div>
                </div>

                <!-- URL -->
                <div class="row">
                    <label>URL</label>
                    <div *ngIf="!editing">{{ dbUrl || '-' }}</div>
                    <div *ngIf="editing">
                        <input type="text" [(ngModel)]="editForm.url" placeholder="https://..." />
                    </div>
                </div>

                <!-- Description HTML -->
                <div class="row">
                    <label>Description (HTML)</label>
                    <div *ngIf="!editing" [innerHTML]="dbDescriptionHtml"></div>
                    <div *ngIf="editing">
                        <textarea rows="6" [(ngModel)]="editForm.description"></textarea>
                    </div>
                </div>

                <!-- Images JSON -->
                <div class="row">
                    <label>Images (JSON)</label>
                    <div *ngIf="!editing" class="mono">
                        <ng-container *ngIf="dbImages?.length; else noImgsFS">
                            {{ dbImages.length }} image(s)
                        </ng-container>
                        <ng-template #noImgsFS>—</ng-template>
                    </div>
                    <div *ngIf="editing">
                        <textarea rows="4" [(ngModel)]="editForm.imageUrls" class="json-input"
                            placeholder='[{"url":"https://...","width":768,"height":1280,"nsfw":false}]'></textarea>
                    </div>
                </div>

            </div>

            <!-- Controls -->
            <div class="overlay-grid" *ngIf="fullSource === 'live'">
                <label>Raw JSON (Model)</label>
                <div class="btn-group">
                    <button (click)="toggleModelRaw()" class="btn btn--ghost btn--sm">
                        {{ showModelRaw ? 'Hide' : 'Show' }}
                    </button>
                    <button *ngIf="showModelRaw && modelRawJson" (click)="copyModelRaw()"
                        class="btn btn--outline btn--sm">
                        Copy
                    </button>
                </div>
            </div>

            <!-- Display highlighted HTML -->
            <pre *ngIf="fullSource === 'live' && showModelRaw" class="json-pre" [innerHTML]="modelRawHtml"></pre>

            <!-- LIVE details in full-screen overlay -->
            <div class="overlay-grid" *ngIf="fullSource === 'live'">
                <!-- your existing summary fields stay here ... -->

                <!-- Raw JSON controls -->
                <div class="row">
                    <label>Raw JSON (Version API)</label>
                    <div class="btn-group">
                        <button (click)="toggleLiveRawJson()" class="btn btn--ghost btn--sm">
                            {{ showLiveRaw ? 'Hide' : 'Show' }}
                        </button>
                        <button *ngIf="showLiveRaw && liveRawJson" (click)="copyLiveRawJson()"
                            class="btn btn--outline btn--sm">
                            Copy
                        </button>
                    </div>
                </div>
            </div>

            <!-- Full-width pretty JSON block (outside the grid for better width) -->
            <pre *ngIf="fullSource === 'live' && showLiveRaw" class="json-pre">{{ liveRawJson }}</pre>

        </ng-container>
    </div>
</div>